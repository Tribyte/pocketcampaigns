{% extends 'campaigns/base.html' %}

{% block head %}
{% load static %}
  <link rel="stylesheet" type="text/css" href="{% static 'campaigns/css/cards.css' %}">
  <link rel="stylesheet" type="text/css" href="{% static 'campaigns/css/check_form.css' %}">
  <!-- <style>.page-content { background-image: linear-gradient(to bottom, rgba(255,255,255,0.8), rgba(255,255,255,0.6)), url({% if campaign.img != None %}'https://res.cloudinary.com/hiz61zutn/image/upload/v1562033986/{{ campaign.img }}'{% else %}'/static/campaigns/img/temp_campaign.jpg'{% endif %}); }</style> -->
{% endblock %}

{% block content %}
  <div id="campaigns">
    <div class="row" style="width: 100%">
      <div class="page-title">
        <h1>{{ card.name }}</h1>
      </div>
    </div>
  </div>
  <div class="row" style="width: calc(100% - 75px); margin: 10px;">
    <div class="col-md-3">
      <div class="card-simple card--1">
        <!-- <div class="card__img" style="background-image: linear-gradient(to bottom, rgba(0,0,0,0.3), rgba(0,0,0,0.1)), url({% if card.img != None %}https://res.cloudinary.com/hiz61zutn/image/upload/v1562033986/{{ card.img }}{% else %}/static/campaigns/img/temp_campaign.jpg{% endif %});"></div> -->
        <!-- <div class="card__img--hover" style="background-image: linear-gradient(to bottom, rgba(0,0,0,0.3), rgba(0,0,0,0.1)), url({% if card.img != None %}https://res.cloudinary.com/hiz61zutn/image/upload/v1562033986/{{ card.img }}{% else %}/static/campaigns/img/temp_campaign.jpg{% endif %});"></div> -->
        <div class="card__info">
          <span class="card__category">{{ card.description }}</span>
        </div>
      </div>
    </div>
  </div>
  <div class="row" style="width: calc(100% - 75px); margin: 10px;">
    <div class="col-md-3">
      <div class="card-simple card--1">
          <div class="todo">
            <div class="top_bar">
              <input placeholder="search/add" id="search_input" maxlength="20"></input><button id="search_button">add</button>
            </div>
            <div class="list">
              <ul id="search_list">
                {% for tag in campaign.tags.all %}
                  <li id="li{{ tag.id }}">
                    <div class="item" id="c{{ tag.id }}">
                      <span class="{% if tag in card.tags.all %}checked{% endif %}">&#10004;</span> {{ tag.tag }}
                    </div>
                    <button class="delete" id="d{{ tag.id }}">X</button>
                  </li>
                {% endfor %}
              </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script>
    $(document).ready(function(){
      $("#search_button").click(function(){
        var text = $("#search_input").val()
        $.ajax({
          type: "GET",
          url: "c{{ card.id }}/" + encodeURIComponent(text),
          success: function(data){
            $("#search_input").val("");
            if(data.substring(0,3) == "dup"){
              $("#c" + data.substring(3, data.length) + " span").addClass("checked");
            }
            else {
              $("#search_list").append("<li><div class='item' id='c" + data + "'><span class='checked'>&#10004;</span> " + text + "</div><button class='delete'>X</button></li>");
            }
          },
        });
      });
      $("#search_list .item").click(function(){
        var text = $(this).attr('id');
        $.ajax({
          type: "GET",
          url: "{{ card.id }}/" + encodeURIComponent(text.substring(1, text.length)) + "/toggle",
          success: function(data){
            $("#search_input").val("");
            if(data == "checked"){
              $("#" + text + " span").addClass("checked");
            }
            if(data == "removed"){
              $("#" + text + " span").removeClass("checked")
            }
          },
        });
      });
      $("#search_list .delete").click(function(){
        var text = $(this).attr('id');
        console.log(text);
        $.ajax({
          type: "GET",
          url: encodeURIComponent(text.substring(1, text.length)) + "/delete",
          success: function(data){
            console.log(data);
            $("#" + data).remove()
          },
        });
      });
      $.ajaxSetup({
        beforeSend: function(xhr, settings) {
          function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie != '') {
              var cookies = document.cookie.split(';');
              for (var i = 0; i < cookies.length; i++) {
                var cookie = jQuery.trim(cookies[i]);
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) == (name + '=')) {
                  cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                  break;
                }
              }
            }
            return cookieValue;
          }
          if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
            // Only send the token to relative URLs i.e. locally.
            xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
          }
        }
      });
    });
  </script>
{% endblock %}
